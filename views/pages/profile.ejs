<link rel="stylesheet" href="/assets/css/profile.css">
<div id="profile">
    <%- include('../partials/statSettings') %>
    <% if (user.updateStatus.updating) { %>
    <div class="card warning">
        <div class="icon"><%= user.updateStatus.details.time_started ? 'update' : 'hourglass' %></div>
        <div class="text">
            <% if (user.updateStatus.details.time_started) { %>
            <p>
                <b>Importing completion data from osu!</b>
                <br>Discovered
                <%= user.updateStatus.details.count_passes_imported.toLocaleString() %> passes so far.
                <br><%= Math.floor(user.updateStatus.details.percent_completed) %>% complete,
                about <%= user.updateStatus.details.time_remaining %> remaining
            </p>
            <% } else { %>
            <p>
                <b>Queued for import (<%= user.updateStatus.details.position_ordinal %> in line)</b>
                <br>This profile is pending import from osu! and we'll get to it soon. Stay tuned!
            </p>
            <% } %>
        </div>
    </div>
    <% } %>
    <div class="card">
        <div class="banner" style="background-image: url('<%= user.banner_url %>')">
            <div class="buttons">
                <a class="btn translucent square" href="https://osu.ppy.sh/users/<%= user.id %>" target="_blank"
                    title="View profile on osu! website">
                    <span class="icon">open_in_new</span>
                </a>
                <button class="btn translucent" onClick="copyText(`<%= copyable %>`)">
                    <span class="icon">content_copy</span>
                    <span>copy stats</span>
                </button>
                <% if (user.id == me?.id && !user.updateStatus.updating) { %>
                <a class="btn translucent" href="/u/<%= user.id %>/update">
                    <span class="icon">update</span>
                    <span>request re-import</span>
                </a>
                <% } %>
            </div>
        </div>
        <div class="basics">
            <img src="<%= user.avatar_url %>" class="avatar">
            <div class="text">
                <div class="name"><%= user.name %></div>
                <div class="flags">
                    <div class="country">
                        <img src="<%= user.country.flag_url %>" class="flag">
                        <span class="label"><%= user.country.name %></span>
                    </div>
                    <% if (user.team.id) { %>
                    <div class="team">
                        <img src="<%= user.team.flag_url %>" class="flag">
                        <span class="label"><%= user.team.name %></span>
                    </div>
                    <% } %>
                </div>
            </div>
            <div class="stats">
                <div class="stat big">
                    <div class="key">global rank</div>
                    <div class="value">#<%= user.stats.rank == -1 ? '-' : user.stats.rank %></div>
                </div>
                <div class="stat big">
                    <div class="key">% completed</div>
                    <div class="value"><%= user.stats.percentage_completed.toFixed(2) %>%</div>
                </div>
                <div class="stat big">
                    <div class="key">maps completed</div>
                    <div class="value"><%= user.stats.count_completed.toLocaleString() %></div>
                </div>
            </div>
        </div>
        <div class="card lighter progress">
            <div class="top">
                <span class="header">completion progress</span>
            </div>
            <div class="stats">
                <div class="stat">
                    <div class="key">maps to complete</div>
                    <div class="value"><%= (user.stats.count_total - user.stats.count_completed).toLocaleString() %>
                    </div>
                </div>
                <div class="stat">
                    <div class="key">playtime to completion</div>
                    <div class="value"><%= user.stats.timeToCompletion %></div>
                </div>
                <div class="stat">
                    <div class="key">playtime spent completing</div>
                    <div class="value"><%= user.stats.timeSpentCompleting %></div>
                </div>
                <div class="stat">
                    <div class="key">total maps</div>
                    <div class="value"><%= user.stats.count_total.toLocaleString() %></div>
                </div>
            </div>
            <div>
                <span class="header">completion by year</span>
            </div>
            <div class="yearly">
                <% for (const yearData of user.yearly) { %>
                <div class="entry">
                    <div class="year"><%= yearData.year %></div>
                    <div class="content">
                        <div class="values">
                            <div class="percent"><%= yearData.percentage_completed.toFixed(2) %>%</div>
                            <div class="count"><%= yearData.count_completed.toLocaleString() %> /
                                <%= yearData.count_total.toLocaleString() %></div>
                        </div>
                        <div class="bar">
                            <div class="filling"
                                style="width: <%= yearData.percentage_completed %>%; background: <%= yearData.color %>">
                            </div>
                        </div>
                    </div>
                </div>
                <% } %>
            </div>
        </div>
        <% if (user.recommended) { %>
        <div class="card lighter recommended">
            <div>
                <span class="header">what to play next</span>
            </div>
            <div class="beatmapCardContainer">
                <% if (user.recommended.beatmaps.length === 0) { %>
                <div class="empty">
                    <p>No recommendations could be made. Check again after passing some new maps.</p>
                </div>
                <% } %>
                <% for (const beatmap of user.recommended.beatmaps) { %>
                <%- include('../partials/beatmapCard', { beatmap }) %>
                <% } %>
            </div>
            <div class="flex row gap-8 justify-center">
                <div class="flex">
                    <a href="/recommended/<%= settings.modeKey %>/<%= settings.includes.join('-') %>?q=<%- user.recommended.beatmaps.length ? user.recommendedQuery : '' %>"
                        class="btn primary">
                        <span class="icon filled">cards_star</span>
                        <span class="label">More like this in play next...</span>
                    </a>
                </div>
            </div>
        </div>
        <% } %>
        <div class="card lighter passes">
            <div>
                <span class="header">recent passes</span>
            </div>
            <div class="beatmapNarrowContainer">
                <% if (user.recentPasses.length === 0) { %>
                <div class="empty">
                    <p>No recent passes found :(</p>
                </div>
                <% } %>
                <% for (const pass of user.recentPasses) { %>
                <%- include('../partials/beatmapNarrow', { beatmap: pass.beatmap, time: `Passed ${pass.timeSincePass}` }) %>
                <% } %>
            </div>
        </div>
    </div>
</div>