<link rel="stylesheet" href="/assets/css/profile.css">
<div id="profile">
    <%- include('../partials/statSettings') %>
    <% if (user.updateStatus.updating) { %>
    <div class="card warning">
        <div class="icon"><%= user.updateStatus.details.time_started ? 'update' : 'hourglass' %></div>
        <div class="text">
            <% if (user.updateStatus.details.time_started) { %>
            <p>
                <b>Importing completion data from osu!</b>
                <br><%= Math.floor(user.updateStatus.details.percent_completed) %>% complete,
                about <%= user.updateStatus.details.time_remaining %> remaining. Discovered
                <%= user.updateStatus.details.count_passes_imported.toLocaleString() %> passes so far.
            </p>
            <% } else { %>
            <p>
                <b>Queued for import (<%= user.updateStatus.details.position_ordinal %> in line)</b>
                <br>This profile is pending import from osu! and we expect to have it done in about
                <%= user.updateStatus.details.time_remaining %>. Stay tuned!
            </p>
            <% } %>
        </div>
    </div>
    <% } %>
    <div class="card">
        <div class="banner" style="background-image: url('<%= user.banner_url %>')">
            <div class="buttons">
                <a class="btn translucent square" href="https://osu.ppy.sh/users/<%= user.id %>" target="_blank"
                    title="View profile on osu! website">
                    <span class="icon">open_in_new</span>
                </a>
                <button class="btn translucent" onClick="copyText(`<%= copyable %>`)">
                    <span class="icon">content_copy</span>
                    <span>copy stats</span>
                </button>
                <% if (user.id == me?.id && !user.updateStatus.updating) { %>
                <button id="reimport" class="btn translucent">
                    <span class="icon">update</span>
                    <span>request re-import</span>
                </button>
                <script>
                    document.getElementById('reimport').addEventListener('click', async () => {
                        const canReimport = '<%= user.updateStatus.canReimport %>';
                        if (canReimport) {
                            showPopup(
                                'Request re-import',
                                `
                                    <p>Are you sure you want to re-import your completion data from osu!?</p>
                                    <p>Note that this is likely unnecessary as we update profiles from their recent scores minutely. Re-importing is only necessary if you suspect that your stats are inaccurate.</p>
                                    <p>Should you choose to continue, the import will take some time depending on how many maps you've passed and how many people are queued ahead of you. The import can't be canceled once started.</p>
                                `,
                                [
                                    {
                                        label: 'Nevermind',
                                        class: 'primary'
                                    },
                                    {
                                        label: 'Continue',
                                        href: '/u/<%= user.id %>/update',
                                    }
                                ]
                            );
                        } else {
                            showPopup(
                                'Too soon to re-import',
                                `
                                    <p>Your profile was imported recently and can't be imported again for another <strong><%= user.updateStatus.timeUntilNextImport %></strong>.</p>
                                    <p>Note that re-importing is likely unnecessary as we update profiles from their recent scores minutely. It's only necessary if you suspect that your stats are inaccurate.</p>
                                `,
                                [
                                    {
                                        label: 'Got it!',
                                        class: 'primary'
                                    }
                                ]
                            );
                        }
                    });
                </script>
                <% } %>
            </div>
        </div>
        <div class="basics">
            <img src="<%= user.avatar_url %>" class="avatar">
            <div class="text">
                <div class="name"><%= user.name %></div>
                <div class="flags">
                    <div class="country">
                        <img src="<%= user.country.flag_url %>" class="flag">
                        <span class="label"><%= user.country.name %></span>
                    </div>
                    <% if (user.team.id) { %>
                    <div class="team">
                        <img src="<%= user.team.flag_url %>" class="flag">
                        <span class="label"><%= user.team.name %></span>
                    </div>
                    <% } %>
                </div>
            </div>
            <div class="stats">
                <div class="stat big">
                    <div class="key">global rank</div>
                    <div class="value">#<%= user.stats.rank == -1 ? '-' : user.stats.rank %></div>
                </div>
                <div class="stat big">
                    <div class="key">% completed</div>
                    <div class="value"><%= user.stats.percentage_completed.toFixed(2) %>%</div>
                </div>
                <div class="stat big">
                    <div class="key">maps completed</div>
                    <div class="value"><%= user.stats.count_completed.toLocaleString() %></div>
                </div>
            </div>
        </div>
        <div class="card lighter progress">
            <div class="top">
                <span class="header">completion progress</span>
            </div>
            <div class="stats">
                <div class="stat">
                    <div class="key">maps to complete</div>
                    <div class="value"><%= (user.stats.count_total - user.stats.count_completed).toLocaleString() %>
                    </div>
                </div>
                <div class="stat">
                    <div class="key">playtime to completion</div>
                    <div class="value"><%= user.stats.timeToCompletion %></div>
                </div>
                <div class="stat">
                    <div class="key">playtime spent completing</div>
                    <div class="value"><%= user.stats.timeSpentCompleting %></div>
                </div>
                <div class="stat">
                    <div class="key">total maps</div>
                    <div class="value"><%= user.stats.count_total.toLocaleString() %></div>
                </div>
            </div>
            <div>
                <span class="header">completion by year</span>
            </div>
            <div class="yearly">
                <% for (const yearData of user.yearly) { %>
                <div class="entry">
                    <div class="year"><%= yearData.year %></div>
                    <div class="content">
                        <div class="values">
                            <div class="percent"><%= yearData.percentage_completed.toFixed(2) %>%</div>
                            <div class="count"><%= yearData.count_completed.toLocaleString() %> /
                                <%= yearData.count_total.toLocaleString() %></div>
                        </div>
                        <div class="bar">
                            <div class="filling"
                                style="width: <%= yearData.percentage_completed %>%; background: <%= yearData.color %>">
                            </div>
                        </div>
                    </div>
                </div>
                <% } %>
            </div>
        </div>
        <% if (user.recommended) { %>
        <div class="card lighter recommended">
            <div>
                <span class="header">what to play next</span>
            </div>
            <div class="beatmapCardContainer">
                <% if (user.recommended.length === 0) { %>
                <div class="empty">
                    <p>Either no recommendations could be made or you've passed all maps in this category.</p>
                </div>
                <% } %>
                <% for (const beatmap of user.recommended) { %>
                <%- include('../partials/beatmapCard', { beatmap }) %>
                <% } %>
            </div>
            <div class="flex row gap-8 justify-center">
                <div class="flex">
                    <a href="/recommended/<%= category %>?q=<%- encodeURIComponent(user.recommendedQuery) %>"
                        class="btn primary">
                        <span class="icon filled">cards_star</span>
                        <span class="label">More like this in play next...</span>
                    </a>
                </div>
            </div>
        </div>
        <% } %>
        <div class="card lighter passes">
            <div>
                <span class="header">recent passes (<%= user.recentPasses.length.toLocaleString() %>)</span>
            </div>
            <div class="beatmapNarrowContainer">
                <% if (user.recentPasses.length === 0) { %>
                <div class="empty">
                    <p>No new passes in the past 24 hours (or since import)</p>
                </div>
                <% } %>
                <% for (const pass of user.recentPasses) { %>
                <%- include('../partials/beatmapNarrow', { beatmap: pass.beatmap, time: `Passed ${pass.timeSincePass}` }) %>
                <% } %>
            </div>
        </div>
    </div>
</div>