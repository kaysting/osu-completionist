<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title><%= `${locals.title ? locals.title + ' - ' : ''}` %>osu!complete</title>
        <meta property="og:site_name" content="osu!complete" />
        <meta
            property="og:title"
            content="<%= locals?.meta?.title || 'osu! completionist tracker and leaderboard' %>" />
        <meta
            name="description"
            content="<%= locals?.meta?.description || 'Track your osu! completion progress across all game modes, ranked, loved, and convert maps, and compare your progress with others!' %>" />
        <meta
            property="og:description"
            content="<%= locals?.meta?.description || 'Track your osu! completion progress across all game modes, ranked, loved, and convert maps, and compare your progress with others!' %>" />
        <meta
            property="og:image"
            content="<%= locals?.meta?.image || locals?.meta?.thumbnail || asset('/assets/images/promo.png') %>" />
        <meta
            name="twitter:image"
            content="<%= locals?.meta?.image || locals?.meta?.thumbnail || asset('/assets/images/promo.png') %>" />
        <% if (!locals?.meta?.thumbnail) { %>
        <meta property="og:image:width" content="1200" />
        <meta property="og:image:height" content="630" />
        <meta name="twitter:card" content="summary_large_image" />
        <% } %>
        <meta name="theme-color" content="#6EF79C" />
        <link rel="icon" type="image/png" href="<%= asset('/assets/images/icon.png') %>" />
        <link rel="stylesheet" href="<%= asset('/assets/css/theme.css') %>" />
        <link rel="stylesheet" href="<%= asset('/assets/css/utils.css') %>" />
        <link rel="stylesheet" href="<%= asset('/assets/css/layout.css') %>" />
        <script src="<%= asset('/assets/js/base.js') %>"></script>
        <script src="<%= asset('/assets/js/partial.js') %>"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.5.1/dist/chart.umd.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.8.1/dist/socket.io.min.js"></script>
        <script src="<%= asset('/assets/js/socket.js') %>"></script>
        <script src="<%= asset('/assets/js/index.js') %>"></script>
    </head>

    <body>
        <!-- Topmost wrapper, centers the sidebar and page content horizontally -->
        <div class="flex justify-center">
            <!-- Sidebar -->
            <script>
                function openSidebar() {
                    document.querySelector('#sidebar').classList.add('open');
                }
                function closeSidebar() {
                    document.querySelector('#sidebar').classList.remove('open');
                }
            </script>
            <nav id="sidebar" class="flex col">
                <div class="top flex align-center justify-center gap-16">
                    <button id="btnCloseSidebar" class="btn text square" onClick="closeSidebar()">
                        <span class="icon">close</span>
                    </button>
                    <div class="logo full">
                        <span class="white">osu!</span>
                        <span class="green">complete</span>
                    </div>
                    <div class="logo short">
                        <span class="white">o!</span>
                        <span class="green">c</span>
                    </div>
                </div>
                <div class="scroll flex col gap-4 flex-grow">
                    <a href="/" class="btn item page <%= page == 'home' ? 'active' : '' %>">
                        <span class="icon">home</span>
                        <span class="label">Home</span>
                    </a>
                    <a href="/search" class="btn item page <%= page == 'search' ? 'active' : '' %>">
                        <span class="icon">search</span>
                        <span class="label">Search players and maps</span>
                    </a>
                    <a href="/leaderboard" class="btn item page <%= page == 'leaderboard' ? 'active' : '' %>">
                        <span class="icon">leaderboard</span>
                        <span class="label">Leaderboard</span>
                    </a>
                    <% if (me) { %>
                    <a
                        class="btn item page <%= page == 'recommended' ? 'active' : '' %>"
                        href="/recommended<%= locals?.category ? `/${locals.category}` : '' %>">
                        <span class="icon filled">cards_star</span>
                        <span class="label">Play next</span>
                    </a>
                    <% } %>
                    <a href="/queue" class="btn item page <%= page == 'queue' ? 'active' : '' %>">
                        <span class="icon">autorenew</span>
                        <span class="label">Import queue</span>
                    </a>
                    <div class="separator"></div>
                    <a href="/discord" class="btn item" target="_blank" rel="noopener noreferrer">
                        <span class="icon">chat</span>
                        <span class="label">Join our Discord</span>
                        <span class="icon">open_in_new</span>
                    </a>
                    <a href="/faq" class="btn item page <%= locals?.title?.toLowerCase() == 'faq' ? 'active' : '' %>">
                        <span class="icon">help</span>
                        <span class="label">FAQs</span>
                    </a>
                    <div class="separator"></div>
                    <a
                        href="/changelog"
                        class="btn item page <%= locals?.title?.toLowerCase() == 'changelog' ? 'active' : '' %>">
                        <span class="icon">update</span>
                        <span class="label">Changelog</span>
                    </a>
                    <a href="/github" class="btn item" target="_blank">
                        <span class="icon">code</span>
                        <span class="label">Source code</span>
                        <span class="icon">open_in_new</span>
                    </a>
                </div>
                <div class="bottom flex col gap-4 flex-no-shrink">
                    <div class="separator"></div>
                    <% if (me) { %>
                    <a href="/u/<%= me.id %>" class="btn item page <%= me.id == locals?.user?.id ? 'active' : '' %>">
                        <img src="<%= me.avatar_url %>" class="icon" />
                        <span class="label"><%= me.name %></span>
                    </a>
                    <a href="/auth/logout" class="btn item">
                        <span class="icon">logout</span>
                        <span class="label">Sign out</span>
                    </a>
                    <% } else { %>
                    <a href="/auth/login" class="btn item">
                        <span class="icon">person</span>
                        <span class="label">Sign in with osu!</span>
                    </a>
                    <% } %>
                </div>
            </nav>

            <!-- Main content wrapper -->
            <div id="content">
                <canvas id="bgCanvas"></canvas>

                <!-- Topbar -->
                <div id="topbar" class="flex gap-16 align-center">
                    <button id="btnOpenSidebar" class="btn text square" onClick="openSidebar()">
                        <span class="icon">menu</span>
                    </button>
                    <div class="logo">
                        <span class="white">o!</span>
                        <span class="green">c</span>
                    </div>
                    <div class="pageSep separator"></div>
                    <div class="page flex gap-12 align-center flex-grow">
                        <div class="icon flex-no-shrink"><%= locals?.topbar?.icon %></div>
                        <h1 class="title"><%= locals?.topbar?.title %></h1>
                    </div>
                </div>

                <!-- Script to initialize and handle topbar scrolled state -->
                <script>
                    function initTopbar() {
                        const topbar = document.getElementById('topbar');
                        document.addEventListener('scroll', () => {
                            if (window.scrollY > 8) {
                                topbar.classList.add('scrolled');
                            } else {
                                topbar.classList.remove('scrolled');
                            }
                        });
                    }
                    initTopbar();
                </script>

                <!-- Dynamic page content -->
                <main data-page="<%= page %>"><%- include('pages/' + page) %></main>

                <div id="bottomShadow"></div>

                <!-- Static footer -->
                <footer id="footer">
                    <p>
                        osu!complete &copy;
                        <a href="https://kaysting.dev">Kayla Kersting</a>
                        2026
                        <br />
                        <a href="/tos">Terms of Service</a>
                        &bullet;
                        <a href="/privacy">Privacy Policy</a>
                        <br />
                        Running commit
                        <a
                            href="https://github.com/kaysting/osu-completionist/commit/<%= locals?.git?.hash %>"
                            target="_blank"
                            rel="noopener noreferrer">
                            <%= locals?.git?.hash %>
                        </a>
                        deployed <%= dayjs(locals?.git?.date).utc().format('YYYY-MM-DD HH:mm:ss [UTC]') %>
                    </p>
                </footer>
            </div>
        </div>

        <!-- Safely load data into JSON scripts so it can be accessed on the client side -->
        <script id="data-changelog" type="application/json">
            <% const changelogHtml = includeMarkdown('views/markdown/changelog.md') %>
            <%- JSON.stringify(changelogHtml) %>
        </script>
        <script id="data-notice" type="application/json">
            <%- JSON.stringify(includeMarkdown('views/markdown/notice.md')) %>
        </script>

        <script>
            // We do this stuff inline so there isn't a delay on load

            // Collect info for dev notice and changelog
            const devMsgVersion = 2;
            const seenDevMsgVersion = parseInt(localStorage.getItem('devNoticeVersion') || '0');
            const hasSeenDevNotice = seenDevMsgVersion >= devMsgVersion;
            const changelogHtml = JSON.parse(document.getElementById('data-changelog').textContent);
            const currentChangelogVersion = `<%= utils.sha256(changelogHtml) %>`;
            const seenChangelogVersion = localStorage.getItem('changelogVersion');

            function showDevNotice() {
                const devNoticeHtml = JSON.parse(document.getElementById('data-notice').textContent);
                const dialog = showPopup(
                    'Welcome to the osu!complete beta!',
                    devNoticeHtml,
                    [
                        {
                            label: 'Join the Discord server',
                            href: '/discord',
                            newTab: true,
                            noClose: true
                        },
                        {
                            label: 'Got it!',
                            class: 'primary'
                        }
                    ],
                    {
                        closedby: 'none',
                        onClose: () => {
                            localStorage.setItem('devNoticeVersion', devMsgVersion.toString());
                            localStorage.setItem('changelogVersion', currentChangelogVersion);
                        }
                    }
                );
            }

            function showChangelog() {
                const dialog = showPopup('Changelog', changelogHtml, [{ label: 'Close' }], {
                    width: 800,
                    height: 900,
                    onClose: () => {
                        localStorage.setItem('changelogVersion', currentChangelogVersion);
                    }
                });
                dialog.setAttribute('data-nosnippet', '');
            }

            // Show dev notice if we haven't seen it yet
            if (!hasSeenDevNotice) {
                showDevNotice();
            }

            // Show changelog if it's new and we've seen the dev notice already
            if (hasSeenDevNotice && seenChangelogVersion !== currentChangelogVersion) {
                showChangelog();
            }
        </script>
    </body>
</html>
